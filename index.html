// index.js
// 3dvr.tech Jetpack Game Prototype using Three.js
// All code is contained in this single file for prototyping

// === GLOBAL VARIABLES ===
let scene, camera, renderer, clock;
let player, playerVelocity;
let billboards = [];  // Array to hold branding billboards

// Physics constants
const GRAVITY    = new THREE.Vector3(0, -9.8, 0); // Gravity (m/s^2)
const THRUST     = 20;    // Upward acceleration when using the jetpack
const MOVE_ACCEL = 10;    // Lateral acceleration for WASD/arrow controls
const MAX_SPEED  = 50;    // Cap the maximum speed

// Object to track key states
const keys = {};

// === INITIALIZATION FUNCTION ===
function init() {
  // Create the scene and set a sky-blue background
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);

  // Create the camera
  camera = new THREE.PerspectiveCamera(
    75, 
    window.innerWidth / window.innerHeight, 
    0.1, 
    1000
  );
  camera.position.set(0, 5, 15);

  // Create the renderer and add its canvas to the document
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Set up a clock for delta timing
  clock = new THREE.Clock();

  // Add some basic lighting
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
  scene.add(ambientLight);
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
  directionalLight.position.set(10, 20, 10);
  scene.add(directionalLight);

  // === PLAYER (JETPACK) SETUP ===
  // Create an empty Object3D to represent the player
  player = new THREE.Object3D();

  // Player body: a simple red sphere
  const bodyGeometry = new THREE.SphereGeometry(0.5, 16, 16);
  const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
  const bodyMesh = new THREE.Mesh(bodyGeometry, bodyMaterial);
  player.add(bodyMesh);

  // Jetpack flame: a small cone that appears when thrusting
  const flameGeometry = new THREE.ConeGeometry(0.2, 0.5, 8);
  const flameMaterial = new THREE.MeshBasicMaterial({ color: 0xffa500 });
  const flameMesh = new THREE.Mesh(flameGeometry, flameMaterial);
  flameMesh.position.set(0, -0.8, 0);
  flameMesh.rotation.x = Math.PI; // Flip so it points downward
  flameMesh.visible = false;        // Only show when the jetpack is active
  flameMesh.name = "flame";
  player.add(flameMesh);

  // Add a small 3dvr.tech branding sign above the player
  addPlayerBranding();

  // Set the starting position and initialize velocity
  player.position.set(0, 2, 0);
  playerVelocity = new THREE.Vector3();
  scene.add(player);

  // === GROUND SETUP ===
  const groundGeometry = new THREE.PlaneGeometry(200, 200);
  const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x228b22 });
  const ground = new THREE.Mesh(groundGeometry, groundMaterial);
  ground.rotation.x = -Math.PI / 2;
  ground.position.y = 0;
  scene.add(ground);

  // === BRANDING BILLBOARDS ===
  // Add several billboards throughout the scene with the 3dvr.tech logo
  addBrandBillboards();

  // === EVENT LISTENERS ===
  window.addEventListener('resize', onWindowResize, false);
  window.addEventListener('keydown', onKeyDown, false);
  window.addEventListener('keyup', onKeyUp, false);

  // Start the render loop
  animate();
}

// === PLAYER BRANDING ===
// Adds a small billboard that displays "3dvr.tech" above the player.
function addPlayerBranding() {
  const branding = createBillboard("3dvr.tech");
  branding.scale.set(0.5, 0.5, 0.5);
  branding.position.set(0, 2, 0);
  branding.name = "branding";
  player.add(branding);
}

// === BRANDING BILLBOARDS ===
// Create several billboards placed around the scene.
function addBrandBillboards() {
  const billboardPositions = [
    { x: 10,  y: 5, z: -20 },
    { x: -15, y: 3, z: 30 },
    { x: 20,  y: 6, z: 15 },
    { x: -25, y: 4, z: -10 },
    { x: 5,   y: 8, z: -5 },
    { x: -10, y: 6, z: 10 }
  ];

  billboardPositions.forEach(pos => {
    const billboard = createBillboard("3dvr.tech");
    billboard.position.set(pos.x, pos.y, pos.z);
    scene.add(billboard);
    billboards.push(billboard);
  });
}

// === CREATE BILLBOARD FUNCTION ===
// Creates a plane mesh whose material is based on a canvas drawing of text.
function createBillboard(text) {
  const canvas = document.createElement('canvas');
  const size = 256;
  canvas.width = size;
  canvas.height = size;
  const context = canvas.getContext('2d');

  // Fill the canvas background
  context.fillStyle = "#ffffff";
  context.fillRect(0, 0, size, size);

  // Draw centered text
  context.font = "40px Arial";
  context.fillStyle = "#000000";
  context.textAlign = "center";
  context.textBaseline = "middle";
  context.fillText(text, size / 2, size / 2);

  // Create a texture from the canvas and apply it to a plane material
  const texture = new THREE.CanvasTexture(canvas);
  texture.needsUpdate = true;
  const material = new THREE.MeshBasicMaterial({
    map: texture,
    side: THREE.DoubleSide,
    transparent: true
  });
  const geometry = new THREE.PlaneGeometry(5, 5);
  return new THREE.Mesh(geometry, material);
}

// === EVENT HANDLERS ===

// Update camera and renderer on window resize
function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

// Record key press events
function onKeyDown(event) {
  keys[event.key] = true;
}

// Record key release events
function onKeyUp(event) {
  keys[event.key] = false;
}

// === ANIMATION LOOP ===
function animate() {
  requestAnimationFrame(animate);
  const delta = clock.getDelta();

  // Update the player's position and velocity based on input
  updatePlayer(delta);

  // Make all billboards rotate to face the camera
  billboards.forEach(billboard => {
    billboard.lookAt(camera.position);
  });

  // Render the scene from the perspective of the camera
  renderer.render(scene, camera);
}

// === PLAYER UPDATE FUNCTION ===
// Applies gravity, jetpack thrust, and lateral movement based on keys.
function updatePlayer(delta) {
  // Start with gravity
  let acceleration = new THREE.Vector3().copy(GRAVITY);

  // If space is pressed, add upward thrust and show the flame
  if (keys[" "] || keys["Spacebar"]) {
    acceleration.y += THRUST;
    const flame = player.getObjectByName("flame");
    if (flame) flame.visible = true;
  } else {
    const flame = player.getObjectByName("flame");
    if (flame) flame.visible = false;
  }

  // Lateral movement (WASD or arrow keys)
  if (keys["w"] || keys["W"] || keys["ArrowUp"]) {
    acceleration.z -= MOVE_ACCEL;
  }
  if (keys["s"] || keys["S"] || keys["ArrowDown"]) {
    acceleration.z += MOVE_ACCEL;
  }
  if (keys["a"] || keys["A"] || keys["ArrowLeft"]) {
    acceleration.x -= MOVE_ACCEL;
  }
  if (keys["d"] || keys["D"] || keys["ArrowRight"]) {
    acceleration.x += MOVE_ACCEL;
  }

  // Update the player's velocity with the current acceleration
  playerVelocity.addScaledVector(acceleration, delta);

  // Limit the maximum speed
  if (playerVelocity.length() > MAX_SPEED) {
    playerVelocity.setLength(MAX_SPEED);
  }

  // Update the player's position based on velocity
  player.position.addScaledVector(playerVelocity, delta);

  // Simple ground collision: keep the player from going below y = 1
  const minHeight = 1;
  if (player.position.y < minHeight) {
    player.position.y = minHeight;
    playerVelocity.y = 0;
  }

  // Apply a bit of damping so the player gradually slows down
  playerVelocity.multiplyScalar(0.99);

  // Smoothly update the camera to follow the player
  const desiredCameraPos = new THREE.Vector3(
    player.position.x,
    player.position.y + 5,
    player.position.z + 10
  );
  camera.position.lerp(desiredCameraPos, 0.1);
  camera.lookAt(player.position);
}

// === START THE GAME ===
init();
